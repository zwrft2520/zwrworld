# HashMap 的扩容机制是怎样的？

## 回答重点

`HashMap` 中的扩容是基于**负载因子（load factor）** 来决定的。默认情况下，`HashMap` 的负载因子为 0.75，这意味着当 `HashMap` 的已存储元素数量超过当前容量的 75% 时，就会触发扩容操作。

例如，初始容量为 16，负载因子为 0.75，则扩容阈值为 `16 × 0.75 = 12`。当存入第 13 个元素时，`HashMap` 就会触发扩容。

当触发扩容时，`HashMap` 的容量会扩大为当前容量的**两倍**。例如，容量从 16 增加到 32，从 32 增加到 64 等。

扩容时，`HashMap` 需要重新计算所有元素的哈希值，并将它们重新分配到新的哈希桶中，这个过程称为**rehashing**。每个元素的存储位置会根据新容量的大小重新计算哈希值，并移动到新的数组中。

## **总结一下**：

* 当扩容发生时，`HashMap` 并不是简单地将元素复制到新数组中。每个元素的哈希值会根据新的数组容量重新计算，因此元素的存储位置会发生变化
* Java 8 之后的扩容不需要每个节点重新 hash 算下标，因为元素的新位置只与高位有关，通过和老数组长度的 & 计算是否为 0 就能判断新下标的位置，因此链表中的元素可能只需要部分移动。这一优化减少了扩容时的计算开销。

## 扩容的考虑

每次扩容都需要遍历当前所有的元素，重新计算哈希值并移动它们到新的位置，因此扩容是一个比较耗时的操作。如果频繁扩容，整体性能会明显下降。

**优化策略**：如果能预估到 `HashMap` 中大概会存储多少数据，可以在创建 `HashMap` 时就指定一个较大的初始容量，以减少扩容次数。例如，对于存储 100 万个元素的 `HashMap`，可以直接设置一个 1024 × 1024 的初始容量，避免多次扩容。
